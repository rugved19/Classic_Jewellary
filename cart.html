<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="styles.css"> 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>  
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>  <!-- Razorpay SDK -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <h2>üõí Your Shopping Cart</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="cartItems"></tbody>
    </table>
    
    <h4>Total: ‚Çπ<span id="cartTotal">0</span></h4>

    <!-- Payment Options -->
    <div class="mt-3">
        <label for="paymentMethod" class="form-label"><strong>Select Payment Method:</strong></label>
        <select id="paymentMethod" class="form-select">
            <option value="cod">Cash on Delivery (COD)</option>
            <option value="razorpay">Online Payment (Razorpay)</option>
        </select>
    </div>

    <button id="checkoutBtn" class="btn btn-success mt-3">Checkout</button>
    <a href="product.html" class="btn btn-secondary mt-3">‚Üê Continue Shopping</a>
</div>

<script>
$(document).ready(function () {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let userName = localStorage.getItem("currentUser");

    // Display Cart Items
    function displayCart() {
        let cartList = $("#cartItems");
        cartList.empty();
        let total = 0;

        if (cart.length === 0) {
            cartList.append(`<tr><td colspan="3" class="text-center">Your cart is empty</td></tr>`);
        } else {
            cart.forEach((item, index) => {
                total += item.price;
                cartList.append(`
                    <tr>
                        <td>${item.name}</td>
                        <td>‚Çπ${item.price}</td>
                        <td><button class="btn btn-danger remove-item" data-index="${index}">‚ùå Remove</button></td>
                    </tr>
                `);
            });
        }
        $("#cartTotal").text(total);
    }

    displayCart(); // Load cart items on page load

    // Remove Item from Cart
    $(document).on("click", ".remove-item", function () {
        let index = $(this).data("index");
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        displayCart();
    });

    // Checkout Button Click
    $("#checkoutBtn").on("click", function () {
        if (cart.length === 0) {
            alert("Cart is empty!");
            return;
        }

        let paymentMethod = $("#paymentMethod").val();
        let totalAmount = $("#cartTotal").text();

        if (!userName) {
            userName = prompt("Enter your name to save your order:");
            if (!userName) {
                alert("Order not placed. Please enter a name.");
                return;
            }
            localStorage.setItem("currentUser", userName);
        }

        if (paymentMethod === "razorpay") {
            processRazorpayPayment(userName, totalAmount);
        } else {
            processCODOrder(userName);
        }
    });

    // Razorpay Payment Processing
    function processRazorpayPayment(userName, totalAmount) {
        var options = {
            "key": "rzp_test_mVHtqP1zNBYC1L", // Replace with your Razorpay Key
            "amount": totalAmount * 100, // Convert amount to paisa
            "currency": "INR",
            "name": "Classic Jewellery",
            "description": "Jewellery Purchase",
            "handler": function (response) {
                saveOrder(userName, "razorpay", response.razorpay_payment_id);
                alert("Payment Successful! Order Placed.");
                window.location.href = "order-placed.html";
            },
            "prefill": {
                "name": userName
            },
            "theme": {
                "color": "#3399cc"
            }
        };
        var rzp = new Razorpay(options);
        rzp.open();
    }

    // COD Order Processing
    function processCODOrder(userName) {
        saveOrder(userName, "cod", "Cash on Delivery");
        alert("Order placed successfully! Pay on delivery.");
        window.location.href = "order-placed.html";
    }

    // Save Order Function
    function saveOrder(userName, paymentMethod, paymentId) {
        let orders = JSON.parse(localStorage.getItem(`orders_${userName}`)) || [];
        let order = {
            date: new Date().toLocaleString(),
            items: [...cart],
            paymentMethod: paymentMethod,
            paymentDetails: paymentId
        };

        orders.push(order);
        localStorage.setItem(`orders_${userName}`, JSON.stringify(orders));
        localStorage.removeItem("cart");
    }
});
</script>

</body>
</html>
